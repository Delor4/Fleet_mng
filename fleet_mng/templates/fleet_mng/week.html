{# Wyświetlenie widoku tygodniowego #}
{% extends "fleet_mng/_base.html" %}
{% block content %}
{% if perms.fleet_mng.add_rent %}
<a href="{% url 'fleet_mng:rent_form' %}" id="newrentbt">Nowe wypożyczenie</a>
{% endif %}
<table id="week_table">
    <tr>
        <th rowspan="2">
            Vehicle
        </th>
        {% for d in days %}{%if forloop.counter0|divisibleby:7 %}
        <th colspan="7">{{ d }}</th>
        {%endif%}
        {% endfor %}
    </tr>
    <tr>

        {% for d in days %}
        <th>{{d.day}}</th>
        {% endfor %}
    </tr>
    {% for vehicle, d in vehicles_table.items %}
    <tr class="{%if vehicle.is_not_bring_back %}not_bring_back{%endif%}">
        <th>
            <div class="{%if vehicle.is_rented %}rented{%endif%}">
                {{vehicle}}
            </div>
        </th>
        {% for h in d %}
        <td class="{%if h.present %}rent_bar{% for r in h.rents %}{% if r.rented %} rented_{{r.id}}{%endif%}{% endfor %}{% else %}no_rent_bar{% endif %}" data-bar="{{ h.classes|join:' ' }}">
            {#{%if h.present %}<a href="{% url 'fleet_mng:rent' h.rents.0.id %}">+</a>{% endif %}#}
        </td>
        {% endfor %}
    </tr>
    {% endfor %}

</table>
<script>
    Array.prototype.diff = function(a) {
        return this.filter(function(i) {return a.indexOf(i) < 0;});
    };
    jQuery(document).ready(function($){
        $('#week_table').find( ".rent_bar" ).each(function() {
            data=$( this ).attr('data-bar').split(/\s+/);
            firsts=[]
            lasts=[]
            mids = []
            rented=[]
             for (let i=0; i<data.length; i++) {
                if(data[i].substr(0,2)=='l_'){
                    lasts.push(data[i].substr(2))
                }else  if(data[i].substr(0,2)=='f_'){
                    firsts.push(data[i].substr(2))
                }else  if(data[i].substr(0,2)=='m_'){
                    mids.push(data[i].substr(2))
                }else  if(data[i].substr(0,2)=='r_'){
                    rented.push(data[i].substr(2))
                }
             }
            shared=[]
            for (let i=0; i<lasts.length; i++) {
                if(firsts.indexOf(lasts[i])!=-1){
                    shared.push(lasts[i])
                    firsts.splice(firsts.indexOf(lasts[i]),1)
                    lasts.splice(i,1)
                    i--
                };
            }
            mids = mids.diff(firsts)
            mids = mids.diff(lasts)
            mids = mids.diff(shared)
            $(this).append('<div class="rent_wrapper"></div>')
            wrapper=$(this).find(".rent_wrapper")
            console.log(wrapper)
            for (let i=0; i<lasts.length; i++) {
                wrapper.append('<a class="end_rent'+
                    (rented.indexOf(lasts[i])>=0?' rented':'')+
                    '" href="/rent/'+
                    lasts[i]+
                    '/"></a>');
            }
            for (let i=0; i<shared.length; i++) {
                wrapper.append('<a class="start_end_rent'+
                    (rented.indexOf(shared[i])>=0?' rented':'')+
                    '" href="/rent/'+shared[i]+'/"></a>');
            }
            for (let i=0; i<firsts.length; i++) {
                wrapper.append('<a class="start_rent'+
                    (rented.indexOf(firsts[i])>=0?' rented':'')+
                    '" href="/rent/'+firsts[i]+'/"></a>');
            }
            console.log(data, firsts, lasts, shared, mids)
            if(mids.length==1){
                wrapper.append('<a class="mid_rent'+
                    (rented.indexOf(mids[0])>=0?' rented':'')+
                    '" href="/rent/'+mids[0]+'/"></a>');
            }
        });
    })


</script>
<a href="{% url 'fleet_mng:week_date' nav.prev_week.year nav.prev_week.month nav.prev_week.day %}"><<</a>
<a href="{% url 'fleet_mng:week_date' nav.prev.year nav.prev.month nav.prev.day %}"><</a>
...
<a href="{% url 'fleet_mng:week_date' nav.next.year nav.next.month nav.next.day %}">></a>
<a href="{% url 'fleet_mng:week_date' nav.next_week.year nav.next_week.month nav.next_week.day %}">>></a>
{% endblock %}
